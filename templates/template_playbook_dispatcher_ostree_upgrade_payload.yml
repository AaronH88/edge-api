# This playbook is meant to be an all-in-one
- name: Run the ostree update in a single play without external deps
  become: true
  hosts: localhost
  vars:
    update_number: "@@ .UpdateNumber @@"
    repo_url: "@@ .RepoURL @@"
    repo_content_url: "@@ .RepoContentURL @@"
    ostree_remote_name: "@@ .GoTemplateRemoteName @@"
    ostree_changes_refs: "@@ .RemoteOstreeUpdate @@"
    os_tree_ref: "@@ .OSTreeRef @@"
    ostree_gpg_verify: "false"
    ostree_gpg_keypath: "/etc/pki/rpm-gpg/"
    ostree_remote_template: |
      [remote "{{ ostree_remote_name }}"]
      url={{ repo_url }}
      gpg-verify={{ ostree_gpg_verify }}
      gpgkeypath={{ ostree_gpg_keypath }}
      contenturl={{ repo_content_url }}
      tls-client-key-path=/etc/pki/consumer/key.pem
      tls-client-cert-path=/etc/pki/consumer/cert.pem
    insights_signature_exclude: "/vars/insights_signature,/vars/update_number,/vars/ostree_remote_name,/vars/ostree_changes_refs,/vars/os_tree_ref"
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldUQlFjaXROZG5jMU9FUXJhalZ3VGtGUmFIVTRVa0ZCYmpkc05Y
      VkZVbFpZUlU1bWRHdGlUVkZQUVU1U1FUTTNUWEJZZVd4Q1lsTUtXRzQwVlRoS1RWbzFhVXA2WkRO
      c2EweDBNalJEZVdrd2NIZzFOSFZGV0RoemIwRlZNa1JhWjJJM1luaHBiUzluWVd0NldWUkRUMjR4
      YVZFd1puQldMd3BKTDB0RVdWUnRZbG8zVFhSVEsxaFpaa1JOZWpCbFpGRnRSbFpJTW5OVVpYZHdZ
      bFZFVkc1cE9XWTVZbXRtWlhoaFJ5dG9NVUZaU1ZsUFIwOXBjeTkzQ21SUlZrODBWV1J3TnpsR1Iy
      bGFkbGc1TUdGVE5WVklReko2V2t3emVtOXpNM0YyWVdGWlV6QXhWVTAxYVdScUwzZzVkMDVyTWt3
      NFFrNDFkMHRWWTIwS1UxWXZWVzV2ZEd0bE9HSmpSVE1yUXl0WVJEUnJkSHBoVFV3ME5rcENZMnBw
      VTNOa1FuZ3hSREZDVVVkdEwwZG1aek5UUTNwM1ZEZHlRVWhJTVZaTGFRb3phek14Y0ZselNteGpS
      MFJtTXpCc2FDOXhaVkE1WVUwdldUUmpjRGRpYldRMlNFbE5hMmt3TUhCS1lqVTFRV0ptZFhOVVZW
      ZERVVWxyZVhGT1ZuRnNDbUZhUmpsWVl6TTNWbTVyVUc5c1JEZElNME5QV2swNGQwMURZbkU1VFVo
      YWRYSTBURGxFZEV0dVlYUjNlV2R1ZUc4eWVFZGpPVkUyTDNRM1YwVk1jSGdLTVRRdk1qVk1OalZO
      V1V4eFRETndXVTAwYUZsSU1FTkVTMFkxYm1aNFRHbE1lRFJJZEZkMlVsTlBhbEJaV21SMFZXVmhj
      WFJxWjFnMVVGTk5OM2x4YndwVFYzWm1kakZuWVhGWFFrcG9SSFZhVEd0VU1HeExORWhKU2k5UVVG
      WmhiWFJYUmxSMGFtRmpVMnd5V25jeFNtSXlVM056ZURJd2FIRmplbTh2ZGxnekNuZ3lTM0pWVDJS
      dWNqZDJabWhFVFdWMFJrVmFLMUZzWlRsMFRFTkhRMmxzU2pWbWJFZEllbEpHTjJKMFdVSnVUVk0z
      UWpWbGJuZFFNV0UwYkd3M01XSUtiRTEyUlVSelRHMXdlWGxaYURONE5sTnRUVnAyYjNORGVHSnFN
      WEE0YzNWNmJFeFVZbkJMZWpOU1ZqbE9XWGh6WjBkbGRrazJSekZ1VVZJMVJIaDRZUXAzWW14NE1W
      ZzVaa2xhUlQwS1BWVkZWbGNLTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - name: apply templated ostree remote config
      ansible.builtin.copy:
        content: "{{ ostree_remote_template }}"
        dest: /etc/ostree/remotes.d/rhel-edge.conf
    - name: run rpmostree update
      when: not ostree_changes_refs|bool
      ansible.builtin.shell: rpm-ostree upgrade --allow-downgrade
      register: rpmostree_upgrade_out
      changed_when: '"No upgrade available" not in rpmostree_upgrade_out.stdout'
      failed_when: 'rpmostree_upgrade_out.rc != 0'
    - name: run rpmostree rebase
      when: ostree_changes_refs|bool
      ansible.builtin.shell: rpm-ostree rebase "{{ os_tree_ref }}"
      register: rpmostree_rebase_out
      changed_when: '"No upgrade available" not in rpmostree_rebase_out.stdout'
      failed_when: 'rpmostree_rebase_out.rc != 0'
    - name: schedule reboot when rpmostree upgraded
      ansible.builtin.shell: systemd-run --on-active=5 /usr/bin/systemctl reboot
      when: ('rpmostree_rebase_out.changed | "Staging deployment...done" in rpmostree_rebase_out.out') or ('rpmostree_upgrade_out.changed | "Staging deployment...done" in rpmostree_upgrade_out.stdout')
